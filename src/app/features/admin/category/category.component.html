<div class="dashboard-container">
  <div class="container-fluid">
    <h2 class="mb-4">Quản lý danh mục</h2>

    <!-- Thanh tìm kiếm và nút tạo -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <div class="flex-grow-1" style="max-width: 250px;">
        <input type="text" class="form-control" placeholder="Tìm kiếm danh mục..."
              [(ngModel)]="searchText" (input)="filterCategories()">
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-success d-flex align-items-center" (click)="exportCategoryReport()">
          <i class="bi bi-file-earmark-pdf me-2 fs-5"></i>
          <span>Xuất báo cáo PDF</span>
        </button>

        <button class="btn btn-primary d-flex align-items-center" (click)="openCreateCategoryModal()">
          <i class="bi bi-plus-circle me-2 fs-5"></i>
          <span>Thêm danh mục</span>
        </button>
      </div>
    </div>

    <!-- Bảng danh mục -->
    <div class="card shadow-sm border-0 rounded-3">
      <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="text-center">#</th>
              <th class="text-center">ID</th>
              <th class="text-center">Tên danh mục</th>
              <th class="text-center">Mô tả</th>
              <th class="text-center">Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let category of filteredCategories; let i = index">
              <td class="text-center">{{ i + 1 + (currentPage * pageSize) }}</td>
                <td class="text-center">{{ category.id }}</td>
              <td class="text-center">{{ category.name }}</td>
              <td class="text-center">{{ category.description }}</td>

              <td class="text-center">
                <button class="btn btn-sm btn-outline-info me-1" (click)="openDetailsModal(category.id)"><i class="bi bi-eye"></i></button>
                <button class="btn btn-warning btn-sm me-2" (click)="openEditModal(category)"><i class="bi bi-pencil-square"></i></button>
                <button class="btn btn-sm btn-outline-danger" (click)="deleteCategory(category)"><i class="bi bi-trash"></i></button>
              </td>
            </tr>

            <tr *ngIf="!loading && categories.length === 0">
              <td colspan="5" class="text-center text-muted py-3">Không có dữ liệu</td>
            </tr>
            <tr *ngIf="loading">
              <td colspan="5" class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Phân trang -->
      <div class="card-footer bg-white py-3 d-flex justify-content-between align-items-center">
        <div class="text-muted small">
          Trang {{ currentPage + 1 }} / {{ totalPages }} ({{ totalElements }} danh mục)
        </div>
        <nav>
          <ul class="pagination mb-0">
            <li class="page-item" [class.disabled]="currentPage === 0">
              <button class="page-link" (click)="previousPage()">&laquo;</button>
            </li>
            <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index" [class.active]="currentPage === i">
              <button class="page-link" (click)="goToPage(i)">{{ i + 1 }}</button>
            </li>
            <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
              <button class="page-link" (click)="nextPage()">&raquo;</button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>


    <!-- Modal tạo danh mục -->
    <div class="modal fade" id="createCategoryModal" tabindex="-1" #createCategoryModal>
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tạo danh mục mới</h5>
            <button type="button" class="btn-close" (click)="closeCreateCategoryModal()"></button>
          </div>
          <div class="modal-body">
            <form [formGroup]="createCategoryForm" (ngSubmit)="submitCreateCategory()">

              <!-- Name -->
              <div class="mb-3">
                <label class="form-label">Tên danh mục</label>
                <input type="text" class="form-control" formControlName="name">
                <div *ngIf="createCategoryForm.get('name')?.invalid && createCategoryForm.get('name')?.touched" class="text-danger small">
                  Tên là bắt buộc.
                </div>
                <div *ngIf="backendErrors['name']" class="text-danger small">
                  {{ backendErrors['name'] }}
                </div>
              </div>

              <!-- Description -->
              <div class="mb-3">
                <label class="form-label">Mô tả</label>
                <textarea class="form-control" formControlName="description"></textarea>
                <div *ngIf="backendErrors['description']" class="text-danger small">
                  {{ backendErrors['description'] }}
                </div>
              </div>

              <button type="submit" class="btn btn-primary" [disabled]="createCategoryForm.invalid">Tạo</button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <!-- Modal Edit Category -->
    <div class="modal fade" #editCategoryModal tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form [formGroup]="editCategoryForm" (ngSubmit)="submitEditCategory()">
            <div class="modal-header">
              <h5 class="modal-title">Chỉnh sửa danh mục</h5>
              <button type="button" class="btn-close" (click)="closeEditModal()" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Tên</label>
                <input type="text" formControlName="name" class="form-control" />
              </div>

              <div class="mb-3">
                <label class="form-label">Mô tả</label>
                <textarea formControlName="description" class="form-control"></textarea>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Đóng</button>
              <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
            </div>
          </form>
        </div>
      </div>
    </div>


    <!-- ========== Category Details Modal ========== -->
    <div class="modal fade" #detailsCategoryModal tabindex="-1" aria-labelledby="detailsCategoryModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title" id="detailsCategoryModalLabel">Thông tin chi tiết danh mục</h5>
            <button type="button" class="btn-close" (click)="closeDetailsModal()" aria-label="Close"></button>
          </div>
          <div class="modal-body" *ngIf="selectedCategoryDetails">
            <p><strong>ID:</strong> {{ selectedCategoryDetails.id }}</p>
            <p><strong>Tên:</strong> {{ selectedCategoryDetails.name }}</p>
            <p><strong>Mô tả:</strong> {{ selectedCategoryDetails.description }}</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeDetailsModal()">Đóng</button>
          </div>
        </div>
      </div>
    </div>
</div>
