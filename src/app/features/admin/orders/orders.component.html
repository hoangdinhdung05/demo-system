<!-- Admin Orders Management -->
<div class="orders-management">
  <div class="page-header">
    <h2><i class="fas fa-shopping-cart"></i> Quản lý đơn hàng</h2>
    <p>Quản lý và theo dõi tất cả đơn hàng</p>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="row align-items-end">
      <div class="col-md-4">
        <label>Tìm kiếm đơn hàng</label>
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input 
            type="text" 
            class="form-control" 
            placeholder="Tìm theo mã đơn hàng, tên KH..."
            (input)="onSearchChange($any($event.target).value)"
          />
        </div>
      </div>
      <div class="col-md-3">
        <label>Lọc theo trạng thái</label>
        <select class="form-control" [(ngModel)]="selectedStatus" (change)="onStatusFilterChange()">
          <option *ngFor="let opt of statusOptions" [ngValue]="opt.value">
            {{ opt.label }}
          </option>
        </select>
      </div>
      <div class="col-md-5 text-right">
        <button class="btn btn-primary" (click)="loadOrders()">
          <i class="fas fa-sync-alt"></i> Làm mới
        </button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="sr-only">Loading...</span>
    </div>
    <p class="mt-2">Đang tải dữ liệu...</p>
  </div>

  <!-- Orders Table -->
  <div *ngIf="!isLoading" class="table-container">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Mã đơn hàng</th>
          <th>Khách hàng</th>
          <th>Số tiền</th>
          <th>Trạng thái</th>
          <th>Thanh toán</th>
          <th>Ngày tạo</th>
          <th>Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of orders">
          <td>
            <strong>{{ order.orderNumber }}</strong>
          </td>
          <td>
            <div>{{ order.receiverName }}</div>
            <small class="text-muted">{{ order.phoneNumber }}</small>
          </td>
          <td>
            <strong class="text-danger">{{ formatCurrency(order.totalAmount) }}</strong>
          </td>
          <td>
            <span class="badge" [ngClass]="getStatusBadgeClass(order.status)">
              {{ getStatusLabel(order.status) }}
            </span>
          </td>
          <td>
            <span class="badge" [ngClass]="order.paymentStatus === 'PAID' ? 'badge-success' : 'badge-warning'">
              {{ order.paymentStatus === 'PAID' ? 'Đã thanh toán' : 'Chưa thanh toán' }}
            </span>
          </td>
          <td>
            <small>{{ formatDate(order.createdAt) }}</small>
          </td>
          <td>
            <button class="btn btn-sm btn-info mr-1" (click)="viewOrderDetails(order)" title="Xem chi tiết">
              <i class="fas fa-eye"></i>
            </button>
            <button 
              class="btn btn-sm btn-primary" 
              (click)="openUpdateStatusModal(order)"
              [disabled]="order.status === 'DELIVERED' || order.status === 'CANCELLED'"
              title="Cập nhật trạng thái"
            >
              <i class="fas fa-edit"></i>
            </button>
          </td>
        </tr>
        <tr *ngIf="orders.length === 0">
          <td colspan="7" class="text-center py-4">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <p class="text-muted">Không có đơn hàng nào</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div *ngIf="!isLoading && totalElements > 0" class="pagination-container">
    <div class="pagination-info">
      Hiển thị {{ currentPage * pageSize + 1 }} - {{ (currentPage + 1) * pageSize > totalElements ? totalElements : (currentPage + 1) * pageSize }} 
      trong tổng số {{ totalElements }} đơn hàng
    </div>
    <nav>
      <ul class="pagination">
        <li class="page-item" [class.disabled]="currentPage === 0">
          <button class="page-link" (click)="goToPage(currentPage - 1)">
            <i class="fas fa-chevron-left"></i>
          </button>
        </li>
        <li 
          *ngFor="let page of getPageNumbers()" 
          class="page-item" 
          [class.active]="page === currentPage"
        >
          <button class="page-link" (click)="goToPage(page)">{{ page + 1 }}</button>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
          <button class="page-link" (click)="goToPage(currentPage + 1)">
            <i class="fas fa-chevron-right"></i>
          </button>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- Order Detail Modal -->
<div class="modal" [class.show]="showDetailModal" *ngIf="showDetailModal && selectedOrder">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chi tiết đơn hàng #{{ selectedOrder.orderNumber }}</h5>
        <button type="button" class="close" (click)="closeDetailModal()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Thông tin khách hàng</h6>
            <p><strong>Người nhận:</strong> {{ selectedOrder.receiverName }}</p>
            <p><strong>Số điện thoại:</strong> {{ selectedOrder.phoneNumber }}</p>
            <p><strong>Địa chỉ:</strong> {{ selectedOrder.shippingAddress }}</p>
          </div>
          <div class="col-md-6">
            <h6>Thông tin đơn hàng</h6>
            <p><strong>Trạng thái:</strong> 
              <span class="badge" [ngClass]="getStatusBadgeClass(selectedOrder.status)">
                {{ getStatusLabel(selectedOrder.status) }}
              </span>
            </p>
            <p><strong>Phương thức TT:</strong> {{ selectedOrder.paymentMethod }}</p>
            <p><strong>Trạng thái TT:</strong> 
              <span class="badge" [ngClass]="selectedOrder.paymentStatus === 'PAID' ? 'badge-success' : 'badge-warning'">
                {{ selectedOrder.paymentStatus === 'PAID' ? 'Đã thanh toán' : 'Chưa thanh toán' }}
              </span>
            </p>
            <p><strong>Ngày tạo:</strong> {{ formatDate(selectedOrder.createdAt) }}</p>
          </div>
        </div>
        
        <hr>
        
        <h6>Sản phẩm</h6>
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Sản phẩm</th>
              <th>Số lượng</th>
              <th>Đơn giá</th>
              <th>Thành tiền</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of selectedOrder.items">
              <td>{{ item.productName }}</td>
              <td>{{ item.quantity }}</td>
              <td>{{ formatCurrency(item.price) }}</td>
              <td>{{ formatCurrency(item.quantity * item.price) }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <th colspan="3" class="text-right">Tổng cộng:</th>
              <th class="text-danger">{{ formatCurrency(selectedOrder.totalAmount) }}</th>
            </tr>
          </tfoot>
        </table>
        
        <div *ngIf="selectedOrder.note">
          <hr>
          <h6>Ghi chú</h6>
          <p>{{ selectedOrder.note }}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDetailModal()">Đóng</button>
      </div>
    </div>
  </div>
</div>

<!-- Update Status Modal -->
<div class="modal" [class.show]="showUpdateStatusModal" *ngIf="showUpdateStatusModal && selectedOrder">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cập nhật trạng thái đơn hàng #{{ selectedOrder.orderNumber }}</h5>
        <button type="button" class="close" (click)="closeUpdateStatusModal()">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Trạng thái hiện tại</label>
          <p>
            <span class="badge" [ngClass]="getStatusBadgeClass(selectedOrder.status)">
              {{ getStatusLabel(selectedOrder.status) }}
            </span>
          </p>
        </div>
        <div class="form-group">
          <label>Trạng thái mới <span class="text-danger">*</span></label>
          <select class="form-control" [(ngModel)]="newStatus">
            <option [value]="OrderStatus.PENDING">Chờ xác nhận</option>
            <option [value]="OrderStatus.CONFIRMED">Đã xác nhận</option>
            <option [value]="OrderStatus.SHIPPING">Đang giao hàng</option>
            <option [value]="OrderStatus.DELIVERED">Đã giao hàng</option>
            <option [value]="OrderStatus.CANCELLED">Đã hủy</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeUpdateStatusModal()">Hủy</button>
        <button type="button" class="btn btn-primary" (click)="submitUpdateStatus()">
          <i class="fas fa-save"></i> Cập nhật
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" *ngIf="showDetailModal || showUpdateStatusModal"></div>
