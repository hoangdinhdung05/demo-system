<div class="dashboard-container">
  <div class="container-fluid">
    <h2 class="mb-4">Quản lý sản phẩm</h2>
    <!-- Thanh tìm kiếm và nút tạo -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <div class="flex-grow-1" style="max-width: 250px;">
        <input type="text" class="form-control" placeholder="Tìm kiếm sản phẩm..."
              [(ngModel)]="searchText" (input)="filterProducts()">
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-success d-flex align-items-center" (click)="exportProductReport()">
          <i class="bi bi-file-earmark-pdf me-2 fs-5"></i>
          <span>Xuất báo cáo PDF</span>
        </button>

        <button class="btn btn-primary d-flex align-items-center" (click)="openCreateModal()">
          <i class="bi bi-plus-circle me-2 fs-5"></i>
          <span>Thêm sản phẩm</span>
        </button>
      </div>
    </div>

    <!-- Bảng sản phẩm -->
    <div class="card shadow-sm border-0 rounded-3">
      <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="text-center">#</th>
              <th class="text-center">ID</th>
              <th class="text-center">Tên sản phẩm</th>
              <th class="text-center">Mô tả</th>
              <th class="text-center">Giá</th>
              <th class="text-center">Số lượng</th>
              <th class="text-center">Ảnh</th>
              <th class="text-center">Action</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let product of filteredProducts; let i = index">
              <td class="text-center">{{ i + 1 + (currentPage * pageSize) }}</td>
              <td class="text-center">{{ product.id }}</td>
              <td class="text-center">{{ product.name }}</td>
              <td class="text-center">{{ product.description }}</td>
              <td class="text-center">{{ product.price | currency }}</td>
              <td class="text-center">{{ product.quantity }}</td>
                <td class="text-center">
                    <img [src]="imageUrl(product)" [alt]="product.name" width="50" height="50">
                </td>

              <td class="text-center">
                <button class="btn btn-sm btn-outline-info me-1" (click)="openDetailsModal(product.id)"><i class="bi bi-eye"></i></button>
                <button class="btn btn-warning btn-sm me-2" (click)="openEditModal(product)"><i class="bi bi-pencil-square"></i></button>
                <button class="btn btn-sm btn-outline-danger" (click)="openDeleteModal(product)"><i class="bi bi-trash"></i></button>
              </td>
            </tr>

            <tr *ngIf="!loading && filteredProducts.length === 0">
              <td colspan="7" class="text-center text-muted py-3">Không có dữ liệu</td>
            </tr>
            <tr *ngIf="loading">
              <td colspan="7" class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Phân trang -->
      <div class="card-footer bg-white py-3 d-flex justify-content-between align-items-center">
        <div class="text-muted small">
          Trang {{ currentPage + 1 }} / {{ totalPages }} ({{ totalElements }} sản phẩm)
        </div>
        <nav>
          <ul class="pagination mb-0">
            <li class="page-item" [class.disabled]="currentPage === 0">
              <button class="page-link" (click)="previousPage()">&laquo;</button>
            </li>
            <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index" [class.active]="currentPage === i">
              <button class="page-link" (click)="goToPage(i)">{{ i + 1 }}</button>
            </li>
            <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
              <button class="page-link" (click)="nextPage()">&raquo;</button>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>


    <!-- Modal tạo sản phẩm -->
    <div class="modal fade" id="createProductModal" tabindex="-1" #createProductModal>
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tạo sản phẩm mới</h5>
            <button type="button" class="btn-close" (click)="closeCreateModal()"></button>
          </div>
          <div class="modal-body">
            <form [formGroup]="createProductForm" (ngSubmit)="submitCreateProduct()">

              <div class="mb-3">
                <label class="form-label">Tên sản phẩm</label>
                <input type="text" class="form-control" formControlName="name">
              </div>

              <div class="mb-3">
                <label class="form-label">Mô tả</label>
                <textarea class="form-control" formControlName="description"></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Giá</label>
                <input type="number" class="form-control" formControlName="price">
              </div>

              <div class="mb-3">
                <label class="form-label">Số lượng</label>
                <input type="text" class="form-control" formControlName="quantity">
              </div>

              <div class="mb-3">
                <label class="form-label">Danh mục</label>
                <select class="form-select" formControlName="categoryId">
                  <option [ngValue]="null">-- Chọn danh mục --</option>
                  <option *ngFor="let c of categoryOptions" [ngValue]="c.id">{{ c.name }}</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">Ảnh sản phẩm <span class="text-danger">*</span></label>
                <input type="file" class="form-control" (change)="onImageSelected($event)" accept="image/jpeg,image/jpg,image/png,image/webp">
                
                <!-- Preview ảnh đã chọn -->
                <div *ngIf="imagePreview" class="mt-2">
                  <img [src]="imagePreview" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                  <p class="text-muted small mt-1">{{ imageFile?.name }} ({{ (imageFile?.size || 0) / 1024 | number:'1.0-2' }} KB)</p>
                </div>
              </div>

              <button type="submit" class="btn btn-primary" [disabled]="createProductForm.invalid || loading">
                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
                {{ loading ? 'Đang xử lý...' : 'Tạo sản phẩm' }}
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>


    <!-- Modal Edit Product -->
    <div class="modal fade" #editProductModal tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <form [formGroup]="editProductForm" (ngSubmit)="submitEditProduct()">
            <div class="modal-header">
              <h5 class="modal-title">Chỉnh sửa sản phẩm</h5>
              <button type="button" class="btn-close" (click)="closeEditModal()" aria-label="Close"></button>
            </div>

            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Tên</label>
                <input type="text" formControlName="name" class="form-control" />
              </div>

              <div class="mb-3">
                <label class="form-label">Mô tả</label>
                <textarea formControlName="description" class="form-control"></textarea>
              </div>

              <div class="mb-3">
                <label class="form-label">Giá</label>
                <input type="number" formControlName="price" class="form-control" />
              </div>
              <div class="mb-3">
                <label class="form-label">Số lượng</label>
                <input type="number" formControlName="quantity" class="form-control" />
              </div>
              <div class="mb-3">
                <label class="form-label">Danh mục</label>
                <select class="form-select" formControlName="categoryId">
                  <option [ngValue]="null">-- Chọn danh mục --</option>
                  <option *ngFor="let c of categoryOptions" [ngValue]="c.id">{{ c.name }}</option>
                </select>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Đóng</button>
              <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
            </div>
          </form>
        </div>
      </div>
    </div>


    <!-- ========== Product Details Modal ========== -->
    <div class="modal fade" #detailsProductModal tabindex="-1" aria-labelledby="detailsProductModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title" id="detailsProductModalLabel">Thông tin chi tiết sản phẩm</h5>
            <button type="button" class="btn-close" (click)="closeDetailsModal()" aria-label="Close"></button>
          </div>
          <div class="modal-body" *ngIf="selectedProductDetails">
            <p><strong>ID:</strong> {{ selectedProductDetails.id }}</p>
            <p><strong>Tên:</strong> {{ selectedProductDetails.name }}</p>
            <p><strong>Mô tả:</strong> {{ selectedProductDetails.description }}</p>
            <p><strong>Giá:</strong> {{ selectedProductDetails.price | currency }}</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeDetailsModal()">Đóng</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== Delete Confirmation Modal ========== -->
    <div class="modal fade" #deleteProductModal tabindex="-1" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="deleteProductModalLabel">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>Xác nhận xóa
            </h5>
            <button type="button" class="btn-close btn-close-white" (click)="closeDeleteModal()" aria-label="Close"></button>
          </div>
          <div class="modal-body" *ngIf="productToDelete">
            <p class="mb-0">Bạn có chắc muốn xóa sản phẩm <strong>"{{ productToDelete.name }}"</strong> không?</p>
            <p class="text-muted small mt-2">Hành động này không thể hoàn tác!</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Hủy</button>
            <button type="button" class="btn btn-danger" (click)="confirmDeleteProduct()">
              <i class="bi bi-trash me-1"></i>Xóa
            </button>
          </div>
        </div>
      </div>
    </div>
</div>
